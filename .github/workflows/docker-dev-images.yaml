name: Docker Build on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same PR
concurrency:
  group: docker-build-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: 'write'

    steps:
    - uses: actions/checkout@v4

    - name: Get short SHA
      id: short_sha
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Record start time
      id: start_time
      run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Comment build started
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const shortSha = `${{ steps.short_sha.outputs.sha_short }}`;
          const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;
          const marker = '<!-- docker-build-comment -->';
          const registryLink = 'https://console.cloud.google.com/artifacts/docker/robusta-development/us-central1/temporary-builds/holmes?project=robusta-development';

          const issue_number = context.payload.pull_request.number;

          const existingComments = await github.paginate(github.rest.issues.listComments, {
            owner,
            repo,
            issue_number,
          });
          const existing = existingComments.find(c => c.body?.includes(marker));

          // Extract previous image tag from existing comment if present
          let previousImageSection = '';
          if (existing) {
            const tagMatch = existing.body.match(/holmes:([a-f0-9]{7})/);
            if (tagMatch && tagMatch[1] !== shortSha) {
              const prevSha = tagMatch[1];
              const prevTag = `us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${prevSha}`;
              previousImageSection = [
                '',
                '---',
                `üì¶ **Previous image (\`${prevSha}\`):**`,
                `- [${prevTag}](${registryLink})`,
                '',
                '<details>',
                '<summary>üìã Copy commands</summary>',
                '',
                '‚ö†Ô∏è Temporary images are deleted after 30 days. Copy to a permanent registry before using them:',
                '```bash',
                'gcloud auth configure-docker us-central1-docker.pkg.dev',
                `docker pull ${prevTag}`,
                `docker tag ${prevTag} me-west1-docker.pkg.dev/robusta-development/development/holmes-dev:${prevSha}`,
                `docker push me-west1-docker.pkg.dev/robusta-development/development/holmes-dev:${prevSha}`,
                '```',
                '',
                'Patch Helm values in one line (choose the chart you use):',
                '',
                '**HolmesGPT chart:**',
                '```bash',
                'helm upgrade --install holmesgpt ./helm/holmes \\\\',
                '  --set registry=me-west1-docker.pkg.dev/robusta-development/development \\\\',
                `  --set image=holmes-dev:${prevSha}`,
                '```',
                '',
                '**Robusta wrapper chart:**',
                '```bash',
                'helm upgrade --install robusta robusta/robusta \\\\',
                '  --reuse-values \\\\',
                '  --set holmes.registry=me-west1-docker.pkg.dev/robusta-development/development \\\\',
                `  --set holmes.image=holmes-dev:${prevSha}`,
                '```',
                '</details>',
              ].join('\n');
            }
          }

          const message = [
            marker,
            `üî® **Building Docker image for \`${shortSha}\`...**`,
            '',
            `[View build logs](${runUrl})`,
            previousImageSection,
          ].join('\n');

          if (existing) {
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: existing.id,
              body: message,
            });
            core.info(`Updated existing PR comment #${existing.id}`);
          } else {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: message,
            });
            core.info(`Commented on PR #${issue_number}`);
          }

    - uses: google-github-actions/auth@v2
      with:
        project_id: 'robusta-development'
        workload_identity_provider: 'projects/479654156100/locations/global/workloadIdentityPools/github/providers/robusta-repos'

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: robusta-development

    - name: Configure Docker Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: linux/arm64,linux/amd64
        push: true
        tags: |
          us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${{ github.sha }}
          us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${{ steps.short_sha.outputs.sha_short }}
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: Print image location
      run: |
        echo "Docker image pushed to:"
        echo "  us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${{ github.sha }}"
        echo "  us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${{ steps.short_sha.outputs.sha_short }}"

    - name: Comment with image details
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const shortSha = `${{ steps.short_sha.outputs.sha_short }}`;
          const jobStatus = `${{ job.status }}`;
          const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;
          const marker = '<!-- docker-build-comment -->';

          // Calculate build duration
          const startTime = parseInt(`${{ steps.start_time.outputs.start }}`);
          const endTime = Math.floor(Date.now() / 1000);
          const durationSecs = endTime - startTime;
          const minutes = Math.floor(durationSecs / 60);
          const seconds = durationSecs % 60;
          const duration = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

          let message;
          if (jobStatus === 'success') {
            const shortTag = `us-central1-docker.pkg.dev/robusta-development/temporary-builds/holmes:${shortSha}`;
            const registryLink = 'https://console.cloud.google.com/artifacts/docker/robusta-development/us-central1/temporary-builds/holmes?project=robusta-development';

            message = [
              marker,
              `‚úÖ **Docker image ready for \`${shortSha}\`** (built in ${duration})`,
              '',
              `- [${shortTag}](${registryLink})`,
              '',
              'Use this tag to pull the image for testing.',
              '',
              '<details>',
              '<summary>üìã Copy commands</summary>',
              '',
              '‚ö†Ô∏è Temporary images are deleted after 30 days. Copy to a permanent registry before using them:',
              '```bash',
              'gcloud auth configure-docker us-central1-docker.pkg.dev',
              `docker pull ${shortTag}`,
              `docker tag ${shortTag} me-west1-docker.pkg.dev/robusta-development/development/holmes-dev:${shortSha}`,
              `docker push me-west1-docker.pkg.dev/robusta-development/development/holmes-dev:${shortSha}`,
              '```',
              '',
              'Patch Helm values in one line (choose the chart you use):',
              '',
              '**HolmesGPT chart:**',
              '```bash',
              'helm upgrade --install holmesgpt ./helm/holmes \\',
              '  --set registry=me-west1-docker.pkg.dev/robusta-development/development \\',
              `  --set image=holmes-dev:${shortSha}`,
              '```',
              '',
              '**Robusta wrapper chart:**',
              '```bash',
              'helm upgrade --install robusta robusta/robusta \\',
              '  --reuse-values \\',
              '  --set holmes.registry=me-west1-docker.pkg.dev/robusta-development/development \\',
              `  --set holmes.image=holmes-dev:${shortSha}`,
              '```',
              '</details>',
            ].join('\n');
          } else {
            message = [
              marker,
              `‚ùå **Docker build failed for \`${shortSha}\`** (after ${duration})`,
              '',
              `[View build logs](${runUrl})`,
            ].join('\n');
          }

          const issue_number = context.payload.pull_request.number;

          const existingComments = await github.paginate(github.rest.issues.listComments, {
            owner,
            repo,
            issue_number,
          });
          const existing = existingComments.find(c => c.body?.includes(marker));

          if (existing) {
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: existing.id,
              body: message,
            });
            core.info(`Updated existing PR comment #${existing.id}`);
          } else {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: message,
            });
            core.info(`Commented on PR #${issue_number}`);
          }
