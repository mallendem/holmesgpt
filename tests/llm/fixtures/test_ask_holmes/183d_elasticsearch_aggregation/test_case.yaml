# Test: Elasticsearch Aggregation Queries
# Tests that Holmes can use Elasticsearch aggregations to summarize data by category
#
# Requirements:
# - ELASTICSEARCH_URL: URL to Elasticsearch cluster
# - ELASTICSEARCH_API_KEY: API key for authentication
#
# Anti-hallucination: The test injects a specific distribution of events by service:
# - payment-api: 5 events
# - order-service: 3 events
# - inventory-api: 2 events
# The LLM cannot know these exact counts without running an aggregation query.

user_prompt: "What is the distribution of events by service in the 'app-183d-events' index? Give me the count of events for each service."

expected_output:
  - "Must report payment-api has 5 events (the highest count)"
  - "Must report order-service has 3 events"
  - "Must report inventory-api has 2 events"
  - "The total event count should be 10"

tags:
  - elasticsearch
  - question-answer
  - medium

setup_timeout: 300

before_test: |
  source ../../shared/es_test_utils.sh
  es_setup
  set -e


  export HOLMES_ES_TEST_INDEX="app-183d-events"

  # Delete the index if it exists
  echo "⏳ Cleaning up any existing test index..."
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true

  # Create the test index
  echo "⏳ Creating test index..."
  CREATE_RESPONSE=$(curl -sf -X PUT "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}?wait_for_active_shards=1" \
    -H "Content-Type: application/json" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    -d '{"settings":{"number_of_shards":1,"number_of_replicas":0},"mappings":{"properties":{"timestamp":{"type":"date"},"service":{"type":"keyword"},"event_type":{"type":"keyword"},"duration_ms":{"type":"integer"}}}}')

  if ! echo "$CREATE_RESPONSE" | grep -q '"acknowledged":true'; then
    echo "❌ Failed to create index: $CREATE_RESPONSE"
    exit 1
  fi

  # Small delay to ensure index is fully ready for queries and bulk operations
  # (wait_for_active_shards only ensures shard allocation)
  sleep 2

  # Create unique temp file
  BULK_FILE="/tmp/es_bulk_183d_$$.ndjson"

  # Create bulk data file with specific distribution:
  # payment-api: 5 events, order-service: 3 events, inventory-api: 2 events
  cat > "$BULK_FILE" << 'BULK_EOF'
  {"index":{}}
  {"timestamp":"2025-01-01T10:01:00Z","service":"payment-api","event_type":"request","duration_ms":110}
  {"index":{}}
  {"timestamp":"2025-01-01T10:02:00Z","service":"payment-api","event_type":"request","duration_ms":120}
  {"index":{}}
  {"timestamp":"2025-01-01T10:03:00Z","service":"payment-api","event_type":"request","duration_ms":130}
  {"index":{}}
  {"timestamp":"2025-01-01T10:04:00Z","service":"payment-api","event_type":"request","duration_ms":140}
  {"index":{}}
  {"timestamp":"2025-01-01T10:05:00Z","service":"payment-api","event_type":"request","duration_ms":150}
  {"index":{}}
  {"timestamp":"2025-01-01T11:01:00Z","service":"order-service","event_type":"request","duration_ms":210}
  {"index":{}}
  {"timestamp":"2025-01-01T11:02:00Z","service":"order-service","event_type":"request","duration_ms":220}
  {"index":{}}
  {"timestamp":"2025-01-01T11:03:00Z","service":"order-service","event_type":"request","duration_ms":230}
  {"index":{}}
  {"timestamp":"2025-01-01T12:01:00Z","service":"inventory-api","event_type":"request","duration_ms":310}
  {"index":{}}
  {"timestamp":"2025-01-01T12:02:00Z","service":"inventory-api","event_type":"request","duration_ms":320}
  BULK_EOF

  # Remove leading spaces from the bulk file
  sed -i 's/^  //' "$BULK_FILE"

  # Index the documents
  BULK_RESPONSE=$(curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_bulk" \
    -H "Content-Type: application/x-ndjson" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    --data-binary @"$BULK_FILE")

  if echo "$BULK_RESPONSE" | grep -q '"errors":true'; then
    echo "❌ Bulk insert had errors: $BULK_RESPONSE"
    rm -f "$BULK_FILE"
    exit 1
  fi

  # Refresh the index
  curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_refresh" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" > /dev/null

  # Clean up temp file
  rm -f "$BULK_FILE"

  # Verify total document count
  DOC_COUNT=$(curl -sf -X GET "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_count" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" | grep -o '"count":[0-9]*' | cut -d':' -f2)

  if [ "$DOC_COUNT" = "10" ]; then
    echo "✅ Test index created with $DOC_COUNT events (payment-api: 5, order-service: 3, inventory-api: 2)"
  else
    echo "❌ Expected 10 events but found: $DOC_COUNT"
    exit 1
  fi

after_test: |

  echo "⏳ Cleaning up test index: app-183d-events"
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/app-183d-events" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true
  echo "✅ Cleanup complete"
