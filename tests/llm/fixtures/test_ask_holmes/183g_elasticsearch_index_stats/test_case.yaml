# Test: Elasticsearch Index Stats Retrieval
# Tests that Holmes can retrieve index-level statistics including document counts and storage
#
# Requirements:
# - ELASTICSEARCH_URL: URL to Elasticsearch cluster
# - ELASTICSEARCH_API_KEY: API key for authentication
#
# Anti-hallucination: The test creates an index with exactly 50 documents.
# The LLM cannot know this count without querying the stats API.

user_prompt: "What are the statistics for the 'app-183g-stats' index? Tell me the document count, store size, and indexing rate."

expected_output:
  - "Must report exactly 50 documents in the index"
  - "Must mention the store size (in bytes or human-readable format)"
  - "Should provide information about the index health"

tags:
  - elasticsearch
  - question-answer
  - medium

setup_timeout: 300

before_test: |
  source ../../shared/es_test_utils.sh
  es_setup
  set -e


  export HOLMES_ES_TEST_INDEX="app-183g-stats"

  # Delete the index if it exists
  echo "⏳ Cleaning up any existing test index..."
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true

  # Create the test index
  echo "⏳ Creating test index..."
  CREATE_RESPONSE=$(curl -sf -X PUT "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}?wait_for_active_shards=1" \
    -H "Content-Type: application/json" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    -d '{
      "settings": {
        "number_of_shards": 1,
        "number_of_replicas": 0
      }
    }')

  if ! echo "$CREATE_RESPONSE" | grep -q '"acknowledged":true'; then
    echo "❌ Failed to create index: $CREATE_RESPONSE"
    exit 1
  fi

  sleep 2

  # Create exactly 50 documents using bulk API
  echo "⏳ Indexing 50 documents..."
  BULK_FILE="/tmp/es_bulk_183g_$$.ndjson"
  > "$BULK_FILE"

  for i in $(seq 1 50); do
    echo '{"index":{}}' >> "$BULK_FILE"
    echo "{\"id\":$i,\"message\":\"Test document number $i\",\"value\":$((i * 10))}" >> "$BULK_FILE"
  done

  BULK_RESPONSE=$(curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_bulk" \
    -H "Content-Type: application/x-ndjson" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    --data-binary @"$BULK_FILE")

  if echo "$BULK_RESPONSE" | grep -q '"errors":true'; then
    echo "❌ Bulk insert had errors: $BULK_RESPONSE"
    rm -f "$BULK_FILE"
    exit 1
  fi

  rm -f "$BULK_FILE"

  # Refresh the index to ensure all documents are searchable
  curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_refresh" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" > /dev/null

  # Verify document count
  DOC_COUNT=$(curl -sf -X GET "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_count" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" | grep -o '"count":[0-9]*' | cut -d':' -f2)

  if [ "$DOC_COUNT" = "50" ]; then
    echo "✅ Test index created with $DOC_COUNT documents"
  else
    echo "❌ Expected 50 documents but found: $DOC_COUNT"
    exit 1
  fi

after_test: |

  echo "⏳ Cleaning up test index: app-183g-stats"
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/app-183g-stats" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true
  echo "✅ Cleanup complete"
