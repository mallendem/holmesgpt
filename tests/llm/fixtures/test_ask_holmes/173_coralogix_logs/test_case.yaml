user_prompt:
  - "The payment service in namespace app-173 is experiencing issues."

expected_output:
  - The answer must identify that database connection timeouts are occurring
  - The answer must mention Database connection pool exhausted, or MaxConnectionsReached

tags:
  - kubernetes
  - chain-of-causation
  - logs
  - coralogix

setup_timeout: 900  # 15 minutes to handle pod scheduling delays

before_test: |
  # Validate required Coralogix environment variables
  [ -n "${CORALOGIX_API_KEY:-}" ] && [ -n "${CORALOGIX_DOMAIN:-}" ] && [ -n "${CORALOGIX_TEAM_HOSTNAME:-}" ] || { for v in CORALOGIX_API_KEY CORALOGIX_DOMAIN CORALOGIX_TEAM_HOSTNAME; do [ -n "${!v:-}" ] || echo "Missing env var: $v"; done; exit 1; }

  echo "üöÄ Setting up test 163 - Creating namespace app-173"
  kubectl create namespace app-173 || true
  echo "‚úÖ Namespace app-173 created successfully!"

  echo "üîê Creating payment-app secret from shared coralogix_app.py"
  kubectl create secret generic payment-app \
    --from-file=app.py=../../shared/coralogix/coralogix_app.py \
    -n app-173 --dry-run=client -o yaml | kubectl apply -f -

  echo "üîê Creating traffic-generator secret from shared traffic_generator.py"
  kubectl create secret generic coralogix-generator-app \
    --from-file=traffic_generator.py=../../shared/coralogix/traffic_generator.py \
    -n app-173 --dry-run=client -o yaml | kubectl apply -f -

  echo "üí≥ Deploying payment service"
  kubectl apply -f payment-service.yaml -n app-173

  echo "‚è≥ Waiting for payment pod to exist"
  for i in {1..60}; do
    if kubectl get pod -l app=payment -n app-173 2>/dev/null | grep -q payment; then
      echo "‚úÖ Payment pod exists"
      break
    fi
    echo "Waiting for payment pod to be created... ($i/60)"
    sleep 2
  done

  echo "‚è≥ Waiting for payment pod to be ready (timeout 780s)"
  PAYMENT_POD_READY=false
  for i in {1..156}; do
    if kubectl wait --for=condition=ready pod -l app=payment -n app-173 --timeout=5s 2>/dev/null; then
      echo "‚úÖ Payment pod is ready!"
      PAYMENT_POD_READY=true
      break
    else
      echo "‚è≥ Attempt $i/156: Payment pod not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$PAYMENT_POD_READY" = false ]; then
    echo "‚ùå Payment pod failed to become ready after 780 seconds"
    kubectl get pods -n app-173 -l app=payment
    exit 1
  fi

  echo "üîç Checking payment deployment status"
  kubectl get pods -n app-173 -l app=payment

  echo "üö¶ Deploying coralogix traffic generator"
  kubectl apply -f traffic-generator.yaml -n app-173

  echo "‚è≥ Waiting for traffic-generator pod to exist"
  for i in {1..60}; do
    if kubectl get pod -l app=traffic-generator -n app-173 2>/dev/null | grep -q traffic-generator; then
      echo "‚úÖ Traffic-generator pod exists"
      break
    fi
    echo "Waiting for traffic-generator pod to be created... ($i/60)"
    sleep 2
  done

  echo "‚è≥ Waiting for traffic-generator pod to be ready (timeout 780s)"
  TRAFFIC_POD_READY=false
  for i in {1..156}; do
    if kubectl wait --for=condition=ready pod -l app=traffic-generator -n app-173 --timeout=5s 2>/dev/null; then
      echo "‚úÖ Traffic-generator pod is ready!"
      TRAFFIC_POD_READY=true
      break
    else
      echo "‚è≥ Attempt $i/156: Traffic-generator pod not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$TRAFFIC_POD_READY" = false ]; then
    echo "‚ùå Traffic-generator pod failed to become ready after 780 seconds"
    kubectl get pods -n app-173 -l app=traffic-generator
    exit 1
  fi

  echo "üîç Checking all pods status"
  kubectl get pods -n app-173

  echo "‚è∞ Waiting for traffic generator to produce requests and errors..."
  TRAFFIC_READY=false
  for i in {1..90}; do
    PAYMENT_LOGS=$(kubectl logs -n app-173 -l app=payment --tail=100 2>/dev/null | grep -c "Processing payment request" || echo "0")
    ERROR_LOGS=$(kubectl logs -n app-173 -l app=payment --tail=100 2>/dev/null | grep -c "ERROR\|WARN" || echo "0")

    if [ "$PAYMENT_LOGS" -gt "10" ] && [ "$ERROR_LOGS" -gt "0" ]; then
      echo "‚úÖ Found required logs after $i seconds:"
      echo "   - Payment processing logs: $PAYMENT_LOGS"
      echo "   - Error/Warning logs: $ERROR_LOGS"
      TRAFFIC_READY=true
      sleep 10
      break
    fi

    echo "‚è≥ Attempt $i/90: PAYMENT=$PAYMENT_LOGS, ERRORS=$ERROR_LOGS"
    sleep 1
  done

  if [ "$TRAFFIC_READY" = false ]; then
    echo "‚ùå Failed to generate required traffic patterns"
    exit 1
  fi

  # Delete traffic generator so the ai won't cheat
  kubectl delete -f traffic-generator.yaml -n app-173

  echo "‚úÖ Test setup complete!"

after_test: |
  kubectl delete namespace app-173 || true
