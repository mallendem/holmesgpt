# Test: Elasticsearch Index Discovery
# Tests that Holmes can list indices and find specific test indices with correct document counts
#
# Requirements:
# - ELASTICSEARCH_URL: URL to Elasticsearch cluster
# - ELASTICSEARCH_API_KEY: API key for authentication
#
# Anti-hallucination: The index name contains a hardcoded identifier 'xq7n4f2p'.
# The LLM cannot know this ID without actually querying the indices.
# The expected_output checks for this exact identifier.

user_prompt: "List all indices in the Elasticsearch cluster that start with 'app-183b-' and tell me the document count for each."

expected_output:
  - "Must find and report the index 'app-183b-data-xq7n4f2p'"
  - "Must report the document count as 5 documents for this index"

tags:
  - elasticsearch
  - question-answer
  - medium

setup_timeout: 300

before_test: |
  source ../../shared/es_test_utils.sh
  es_setup
  set -e


  # Hardcoded index name with identifier for anti-hallucination testing
  export HOLMES_ES_TEST_INDEX="app-183b-data-xq7n4f2p"
  echo "Using test index: $HOLMES_ES_TEST_INDEX"

  # Clean up any existing index first
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true

  # Create the test index with 5 documents
  echo "⏳ Creating test index with 5 documents..."

  # Create the index with wait_for_active_shards to ensure it's ready
  CREATE_RESPONSE=$(curl -sf -X PUT "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}?wait_for_active_shards=1" \
    -H "Content-Type: application/json" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    -d '{"settings": {"number_of_shards": 1, "number_of_replicas": 0}}')

  if ! echo "$CREATE_RESPONSE" | grep -q '"acknowledged":true'; then
    echo "❌ Failed to create index: $CREATE_RESPONSE"
    exit 1
  fi

  # Small delay to ensure index is fully ready
  sleep 2

  # Index 5 documents using bulk API
  BULK_DATA=""
  for i in 1 2 3 4 5; do
    BULK_DATA="${BULK_DATA}{\"index\":{}}\n{\"message\":\"Test document $i for Holmes eval\",\"level\":\"INFO\",\"timestamp\":\"2025-01-01T12:00:0${i}Z\"}\n"
  done

  BULK_RESPONSE=$(echo -e "$BULK_DATA" | curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_bulk" \
    -H "Content-Type: application/x-ndjson" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    --data-binary @-)

  if echo "$BULK_RESPONSE" | grep -q '"errors":true'; then
    echo "❌ Bulk insert had errors: $BULK_RESPONSE"
    exit 1
  fi

  # Refresh the index to make documents searchable
  curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_refresh" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" > /dev/null

  # Verify documents were indexed
  DOC_COUNT=$(curl -sf -X GET "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_count" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" | grep -o '"count":[0-9]*' | cut -d':' -f2)

  if [ "$DOC_COUNT" = "5" ]; then
    echo "✅ Test index created with $DOC_COUNT documents: $HOLMES_ES_TEST_INDEX"
  else
    echo "❌ Expected 5 documents but found: $DOC_COUNT"
    exit 1
  fi

after_test: |

  echo "⏳ Cleaning up test index: app-183b-data-xq7n4f2p"
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/app-183b-data-xq7n4f2p" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true
  echo "✅ Cleanup complete"
