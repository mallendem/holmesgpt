# Test: Elasticsearch Log Search with Query DSL
# Tests that Holmes can search logs using Elasticsearch Query DSL and find specific error patterns
#
# Requirements:
# - ELASTICSEARCH_URL: URL to Elasticsearch cluster
# - ELASTICSEARCH_API_KEY: API key for authentication
#
# Anti-hallucination: The test injects 3 specific error codes (ERR-XXXX format with random numbers).
# The LLM cannot know these error codes without actually searching the index.
# Expected output requires finding these specific error codes.

user_prompt: "Search the 'app-183c-logs' index for ERROR level log messages. What error codes (format ERR-XXXX) appear in the logs?"

expected_output:
  - "Must identify that there are ERROR level logs in the index"
  - "Must find and list the 3 specific error codes that were injected: ERR-7291, ERR-4058, and ERR-9463"
  - "The response should mention the error messages associated with these codes"

tags:
  - elasticsearch
  - logs
  - medium

setup_timeout: 300

before_test: |
  source ../../shared/es_test_utils.sh
  es_setup
  set -e


  export HOLMES_ES_TEST_INDEX="app-183c-logs"

  # Delete the index if it exists (clean slate)
  echo "⏳ Cleaning up any existing test index..."
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true

  # Create the test index with mapping (wait for shard to be active)
  echo "⏳ Creating test index with log mapping..."
  CREATE_RESPONSE=$(curl -sf -X PUT "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}?wait_for_active_shards=1" \
    -H "Content-Type: application/json" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    -d '{"settings":{"number_of_shards":1,"number_of_replicas":0},"mappings":{"properties":{"timestamp":{"type":"date"},"level":{"type":"keyword"},"service":{"type":"keyword"},"error_code":{"type":"keyword"},"message":{"type":"text"}}}}')

  if ! echo "$CREATE_RESPONSE" | grep -q '"acknowledged":true'; then
    echo "❌ Failed to create index: $CREATE_RESPONSE"
    exit 1
  fi

  sleep 2

  # Define the specific error codes for anti-hallucination testing
  ERROR_CODE_1="ERR-7291"
  ERROR_CODE_2="ERR-4058"
  ERROR_CODE_3="ERR-9463"

  # Create unique temp file
  BULK_FILE="/tmp/es_bulk_183c_$$.ndjson"

  # Create bulk data file with mixed log levels and specific error codes
  cat > "$BULK_FILE" << BULK_EOF
  {"index":{}}
  {"timestamp":"2025-01-01T10:00:00Z","level":"INFO","service":"payment-api","message":"Service started successfully"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:05:00Z","level":"ERROR","service":"payment-api","error_code":"${ERROR_CODE_1}","message":"Database connection timeout - ${ERROR_CODE_1}: Failed to connect to primary database after 30s"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:06:00Z","level":"WARN","service":"payment-api","message":"Retrying database connection"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:10:00Z","level":"ERROR","service":"order-service","error_code":"${ERROR_CODE_2}","message":"Payment validation failed - ${ERROR_CODE_2}: Invalid card number format"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:15:00Z","level":"INFO","service":"order-service","message":"Processing order batch complete"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:20:00Z","level":"ERROR","service":"inventory-api","error_code":"${ERROR_CODE_3}","message":"Stock sync failed - ${ERROR_CODE_3}: External inventory API returned 503"}
  {"index":{}}
  {"timestamp":"2025-01-01T10:25:00Z","level":"INFO","service":"inventory-api","message":"Recovered from temporary outage"}
  BULK_EOF

  # Remove leading spaces from the bulk file
  sed -i 's/^  //' "$BULK_FILE"

  # Index the documents
  BULK_RESPONSE=$(curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_bulk" \
    -H "Content-Type: application/x-ndjson" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    --data-binary @"$BULK_FILE")

  if echo "$BULK_RESPONSE" | grep -q '"errors":true'; then
    echo "❌ Bulk insert had errors: $BULK_RESPONSE"
    rm -f "$BULK_FILE"
    exit 1
  fi

  # Refresh the index
  curl -sf -X POST "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_refresh" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" > /dev/null

  # Clean up temp file
  rm -f "$BULK_FILE"

  # Verify ERROR logs exist
  ERROR_COUNT=$(curl -sf -X GET "${ELASTICSEARCH_URL}/${HOLMES_ES_TEST_INDEX}/_count" \
    -H "Content-Type: application/json" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" \
    -d '{"query":{"term":{"level":"ERROR"}}}' | grep -o '"count":[0-9]*' | cut -d':' -f2)

  if [ "$ERROR_COUNT" = "3" ]; then
    echo "✅ Test index created with $ERROR_COUNT ERROR logs containing codes: $ERROR_CODE_1, $ERROR_CODE_2, $ERROR_CODE_3"
  else
    echo "❌ Expected 3 ERROR logs but found: $ERROR_COUNT"
    exit 1
  fi

after_test: |

  echo "⏳ Cleaning up test index: app-183c-logs"
  curl -sf -X DELETE "${ELASTICSEARCH_URL}/app-183c-logs" \
    -H "Authorization: ApiKey ${ELASTICSEARCH_API_KEY}" || true
  echo "✅ Cleanup complete"
