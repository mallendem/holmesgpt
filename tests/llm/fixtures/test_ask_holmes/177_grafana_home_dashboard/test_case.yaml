user_prompt: "Can you get the home dashboard from Grafana and tell me the title, list of panels/widgets, and the time range?"

expected_output:
  - The dashboard title is "Home"
  - The dashboard contains a "Welcome Panel" or welcome widget
  - The dashboard contains a "Dashboards" panel showing recently viewed dashboards
  - The dashboard time range is "now-6h to now" (last 6 hours)

before_test: |
  set -e  # Exit immediately if any command fails
  kubectl create namespace app-177 --save-config --dry-run=client -o yaml | kubectl apply -f - || true
  kubectl apply -f ../../shared/grafana.yaml -n app-177
  
  # Wait for Grafana pod to be ready
  echo "⏳ Waiting for Grafana pod to be ready..."
  POD_READY=false
  for i in {1..60}; do
    if kubectl wait --for=condition=ready pod -l app=grafana -n app-177 --timeout=5s 2>/dev/null; then
      echo "✅ Grafana pod is ready!"
      POD_READY=true
      break
    else
      echo "⏳ Attempt $i/60: Grafana pod not ready yet, waiting 1s..."
      sleep 1
    fi
  done
  
  if [ "$POD_READY" = false ]; then
    echo "❌ Grafana pod failed to become ready after 60 seconds"
    kubectl get pods -n app-177
    kubectl describe pod -l app=grafana -n app-177
    exit 1
  fi
  
  # Verify Grafana API is working using kubectl exec (no port forward needed for setup)
  echo "⏳ Verifying Grafana API..."
  API_READY=false
  for i in {1..30}; do
    if kubectl exec -n app-177 deployment/grafana -- wget -q -O- http://localhost:3000/api/dashboards/home 2>/dev/null | grep -q '"title":"Home"' && \
       kubectl exec -n app-177 deployment/grafana -- wget -q -O- http://localhost:3000/api/dashboards/home 2>/dev/null | grep -q '"type":"welcome"' && \
       kubectl exec -n app-177 deployment/grafana -- wget -q -O- http://localhost:3000/api/dashboards/home 2>/dev/null | grep -q '"type":"dashlist"'; then
      echo "✅ Grafana home dashboard API is working with expected content!"
      API_READY=true
      break
    else
      echo "⏳ Attempt $i/30: Grafana API not ready yet, waiting 1s..."
      sleep 1
    fi
  done
  
  if [ "$API_READY" = false ]; then
    echo "❌ Grafana home dashboard API failed verification"
    echo "Checking pod logs..."
    kubectl logs -l app=grafana -n app-177 --tail=20
    exit 1
  fi
  
  echo "✅ Test setup completed successfully - Grafana home dashboard verified!"

after_test: |
  kubectl delete namespace app-177 || true

port_forwards:
  - namespace: app-177
    service: grafana
    local_port: 10177
    remote_port: 3000

tags:
  - easy
  - question-answer
  - metrics
  - kubernetes
  - grafana-dashboard
