user_prompt:
- "The /checkout endpoint in namespace app-124 is experiencing high latency. Investigate why."

expected_output:
  - The answer must explicitly state that queries that include a promo code are slow or all slow requests include promo code.
  - Including a query that mentions promo code is not sufficient.

tags:
  - kubernetes
  - hard
  - chain-of-causation
  - prometheus

port_forwards:
  - namespace: app-124
    service: prometheus
    local_port: 10124
    remote_port: 9090

before_test: |
  set -e  # Exit immediately if any command fails
  kubectl create namespace app-124 --save-config --dry-run=client -o yaml | kubectl apply -f - || true
  kubectl apply -f prometheus-config.yaml -n app-124
  kubectl apply -f ../../shared/prometheus.yaml -n app-124
  kubectl apply -f holmes-all-in-one-fast.yaml -n app-124

  echo "‚è≥ Waiting for prometheus pod to be ready..."
  PROM_READY=false
  for i in {1..60}; do
    if kubectl wait --for=condition=ready pod -l app=prometheus -n app-124 --timeout=5s 2>/dev/null; then
      echo "‚úÖ Prometheus pod is ready!"
      PROM_READY=true
      break
    fi
    echo "‚è≥ Attempt $i/60: Prometheus not ready yet..."
    sleep 1
  done
  if [ "$PROM_READY" = false ]; then
    echo "‚ùå Prometheus failed to become ready"
    kubectl get pods -n app-124 -l app=prometheus
    kubectl logs -n app-124 -l app=prometheus --tail=20
    exit 1
  fi

  ./run-holmes-check-curl-jq.sh
  echo "üßπ Cleaning up k6 job and pods to prevent AI detection"
  kubectl delete job k6-coupon-split -n app-124 --ignore-not-found=true
  kubectl delete pods -n app-124 -l job-name=k6-coupon-split --ignore-not-found=true
  echo "‚úÖ Test setup completed successfully"

after_test: |
  kubectl delete namespace app-124 || true
